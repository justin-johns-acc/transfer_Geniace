<!DOCTYPE html>
<html>
<body>

<h2>Transfer GeniaceNFT - Testnet</h2>



<!-- <div>
	<button onclick="getLatestBlock()" >Get Latest Block </button>
	<div id='blockResponse'></div>
</div>

<br/><br/> -->

<!-- <div>
	<input id='account' value='5555a83349295167' placeholder="Enter Flow address">
	<button onclick="getAccount()" >Lookup Account </button>
	<div id='getAccounResponse'></div>
</div>

<br/><br/> -->

<!-- 
<div>
	<textarea id='script'>
		pub fun main(): Int {
 			 return 42 + 6
		}
	</textarea>
	<button onclick="runScript()" >Run Script</button>
	<div id='runScriptResponse'></div>
</div> -->


<br/><br/>


<div>
	
	<button onclick="window.fcl.authenticate()" >Login</button>
	<button onclick="window.fcl.unauthenticate()" >Logout</button>

	<div id='loginResponse'></div>
</div>


<br/><br/>

<div>
  <!-- 0x54736a7d074d7816 -->
	RECIPIENT ADDRESS:<textarea id='recipient'> </textarea><br>
  TOKEN ID:<textarea id='tokenId'></textarea><br>
	<button onclick="sendTransaction()" >Send Transaction</button>
	<div id='sendTransactionResponse'></div>
    


</div>


<script src="fcl.js"></script>
<script src="https://unpkg.com/@onflow/types@0.0.5/dist/types.umd.js"></script>

<script>
window.fcl.config()
  .put("accessNode.api", "https://access-testnet.onflow.org")
  .put("challenge.handshake", "https://flow-wallet-testnet.blocto.app/authn") 

const transactionScript = `
import NonFungibleToken from 0x631e88ae7f1d7c20
import GeniaceNFT from 0x99eb28310626e56a

// This transaction transfers a Geniace NFT from one account to another.

transaction(recipient: Address, withdrawID: UInt64) {
    prepare(signer: AuthAccount) {
        
        // get the recipients public account object
        let recipient = getAccount(recipient)

        // borrow a reference to the signer's NFT collection
        let collectionRef = signer.borrow<&GeniaceNFT.Collection>(from: GeniaceNFT.CollectionStoragePath)
            ?? panic("Could not borrow a reference to the owner's collection")

        // borrow a public reference to the receivers collection
        let depositRef = recipient.getCapability(GeniaceNFT.CollectionPublicPath)!.borrow<&{NonFungibleToken.CollectionPublic}>()!

        // withdraw the NFT from the owner's collection
        let nft <- collectionRef.withdraw(withdrawID: withdrawID)

        // Deposit the NFT in the recipient's collection
        depositRef.deposit(token: <-nft)
    }
}

`

window.fcl.currentUser().subscribe(user => showUser({...user}))

var showUser = function(user){
	console.log(user);
	
	    document.getElementById('loginResponse').innerText = JSON.stringify(user);
}
var getLatestBlock = async function() {
    const response = await window.fcl.send([
      window.fcl.getLatestBlock(),
    ]);
    var r  = await window.fcl.decode(response);
    document.getElementById('blockResponse').innerText = JSON.stringify(r);
}

var getAccount = async function() {
    const response = await window.fcl.send([
      window.fcl.getAccount(document.getElementById('account').value),
    ]);
    var r  = await window.fcl.decode(response);
    document.getElementById('getAccounResponse').innerText = JSON.stringify(r);
}

var runScript = async function() {
    const response = await window.fcl.send([
      window.fcl.script(document.getElementById('script').value),
    ]);
    var r  = await window.fcl.decode(response);
    document.getElementById('runScriptResponse').innerText = JSON.stringify(r);
}

var setStatus = function(status){
    document.getElementById('sendTransactionResponse').innerText = status;
}

var sendTransaction = async function() {
    // const response = await window.fcl.send([
    //   window.fcl.script(document.getElementById('script').value),
    // ]);
    console.log("recepient:",document.getElementById('recipient').value);
    console.log("token Id:",document.getElementById('tokenId').value);

    setStatus("Resolving...")

    const blockResponse = await window.fcl.send([
      window.fcl.getLatestBlock(),
    ])

    const block = await window.fcl.decode(blockResponse)

    try {
      const { transactionId } = await window.fcl.send([
        window.fcl.transaction(transactionScript),
        window.fcl.args([
          window.fcl.arg(document.getElementById('recipient').value.trim(), window.types.Address),
          window.fcl.arg(parseInt(document.getElementById('tokenId').value), window.types.UInt64),
        ]),
        window.fcl.proposer(window.fcl.currentUser().authorization),
        window.fcl.authorizations([window.fcl.currentUser().authorization]),
        window.fcl.payer(window.fcl.currentUser().authorization),
        window.fcl.ref(block.id),
        window.fcl.limit(9999),
          ])

      setStatus("Transaction sent, waiting for confirmation")

      const unsub = fcl
        .tx({ transactionId })
        .subscribe(transaction => {

          if (window.fcl.tx.isSealed(transaction)) {
            console.log("Transaction:",transaction);
            setStatus("Transaction is Sealed")
            unsub()
          }
        })
    } catch (error) {
      console.error(error);
      setStatus("Transaction failed")
    }
 }


</script>

</body>
</html> 
